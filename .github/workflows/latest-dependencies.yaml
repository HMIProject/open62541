# yaml-language-server: $schema=https://json.schemastore.org/github-workflow

name: latest-dependencies

permissions:
  contents: read

on:
  pull_request:
  push:
    branches:
      - main
  schedule:
    # Weekly, i.e. on Monday at 03:20 UTC
    - cron: "20 3 * * 1"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_INCREMENTAL: 0
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: short

jobs:
  run:
    strategy:
      # Don't give up on the whole matrix if one variant fails.
      fail-fast: false
      matrix:
        # Keep target archs in sync with `test.yaml`. Use latest versions of
        # runner OS here and supported ones in `test.yaml`.
        include:
          - target: aarch64-apple-darwin
            runner_os: macos-latest
          - target: armv7-unknown-linux-gnueabihf
            runner_os: ubuntu-latest
          - target: x86_64-apple-darwin
            runner_os: macos-latest
          - target: x86_64-pc-windows-msvc
            runner_os: windows-latest
          - target: x86_64-unknown-linux-gnu
            runner_os: ubuntu-latest
          - target: x86_64-unknown-linux-musl
            runner_os: ubuntu-latest

    runs-on: ${{ matrix.runner_os }}

    steps:
      - name: Adjust build settings for Windows
        if: startsWith(matrix.runner_os, 'windows-')
        # Required for Windows builds: for version numbers with pre-release part
        # as suffix, the resulting paths would get too long to build otherwise.
        #
        # Windows 2025 and later do not provision a drive D and we have to use the main drive C:
        # for Cargo build artifacts: <https://github.com/actions/runner-images/issues/12416>
        run: >-
          echo "CARGO_TARGET_DIR=C:\t" >> $env:GITHUB_ENV

      - name: Install Rust toolchain
        # Use latest stable Rust version.
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        uses: taiki-e/setup-cross-toolchain-action@v1
        with:
          # Setting the target sets the `CARGO_BUILD_TARGET` environment variable,
          # so there is no need for an explicit `--target` flag in each build step.
          # This is required for both native and cross-platform builds to avoid
          # using the default target of the runner.
          target: ${{ matrix.target }}

      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Install Cargo helpers
        run: >-
          cargo binstall cargo-hack

      # Check out the repository before the remaining steps that depend on it.
      # All preceding steps are independent of the repository contents.
      - name: Check out repository
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Cache Rust toolchain and build artifacts
        uses: Swatinem/rust-cache@v2
        with:
          # The cache should not be shared between different workflows, jobs, and targets.
          shared-key: ${{ github.workflow }}-${{ github.job }}-${{ matrix.target }}-${{ matrix.runner_os }}

      - name: Update crates to latest versions
        run: >-
          cargo update --verbose

      - name: Build with feature combinations
        run: >-
          cargo hack --each-feature
          build --locked

      - name: Run tests (bins/lib/tests/examples) with feature combinations
        # Disable tests for musl libc target(s) due to build failure for unknown reasons.
        # TODO: Try to re-enable this step regardless of the build target in the future.
        if: ${{ !endsWith(matrix.target, '-musl') }}
        # TODO: Remove custom RUSTFLAGS for x86_64-unknown-linux-gnu after linking issues
        # with rust-lld have been resolved.
        # See also: <https://github.com/HMIProject/open62541/issues/288>
        env:
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS: "-Clinker-features=-lld"
        run: >-
          cargo hack --each-feature
          test --locked
          --bins --lib --tests --examples

      # Compile and run doctests, which have been excluded in the previous
      # step(s).
      #
      # Doctests may use any features and there is no easy way to activate
      # certain features only for some doctests, so we run them without
      # `cargo-hack`.
      - name: Run doctests with all features enabled
        # Disable tests for musl libc target(s) due to build failure for unknown reasons.
        # TODO: Try to re-enable this step regardless of the build target in the future.
        if: ${{ !endsWith(matrix.target, '-musl') }}
        # TODO: Remove custom RUSTFLAGS for x86_64-unknown-linux-gnu after linking issues
        # with rust-lld have been resolved.
        # See also: <https://github.com/HMIProject/open62541/issues/288>
        env:
          CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS: "-Clinker-features=-lld"
        run: >-
          cargo test
          --locked --all-features
          --doc

      - name: Build package with all features enabled
        # We allow dirty state here because it is only expected after update.
        run: >-
          cargo package
          --locked --all-features
          --allow-dirty
